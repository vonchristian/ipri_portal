<div class="px-6 md:px-12 lg:px-20">

  <div class="md:col-span-6 mt-6 ml-2">
    <!-- Header and Download Button -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
      <h1 class="text-xl font-semibold text-gray-900 mb-2 sm:mb-0">Key Data Points</h1>
      <%= link_to 'Download', documenters_dashboard_index_path(format: 'xlsx'), class:"py-1.5 px-4 text-sm font-medium text-gray-900 bg-white border border-gray-300 rounded-md hover:bg-gray-100 hover:text-blue-700" %>
    </div>

    <!-- Summary Pills Grid -->
    <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-4 mt-4">
      <% summary_data = [
        { path: "/documenters/case_details", label: "Total Cases", count: @dashboard[:case_details_count], sub: @dashboard[:current_year_case_details_count], color: "bg-red-100 text-red-700" },
        { path: "/criminalizations", label: "Criminalizations", count: @dashboard[:criminalizations_count], sub: @dashboard[:current_year_criminalizations_count], color: "bg-yellow-100 text-yellow-700" },
        { path: "/killings", label: "Killings", count: @dashboard[:killings_count], sub: @dashboard[:current_year_killings_count], color: "bg-blue-100 text-blue-700" },
        { path: "/human_rights_violations", label: "Other Violations", count: @dashboard[:human_rights_violations_count], sub: @dashboard[:current_year_human_rights_violations_count], color: "bg-green-100 text-green-700" }
      ] %>

      <% summary_data.each do |item| %>
        <a href="<%= item[:path] %>" class="p-4 rounded-xl border border-gray-200 hover:shadow-sm transition bg-white">
          <div class="flex flex-col gap-1">
            <div class="text-xs text-gray-500 tracking-wide uppercase"><%= item[:label] %></div>
            <div class="text-2xl font-bold text-gray-900 leading-tight"><%= item[:count] %></div>
            <div class="text-xs <%= item[:color] %> rounded px-2 py-0.5 w-fit mt-1">
              <%= item[:sub] %> this year
            </div>
          </div>
        </a>
      <% end %>
    </div>
  </div>

  <div class="border-t border-gray-200 mt-4 mb-4"></div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Leaderboard Column -->
    <div class="lg:col-span-1">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Human Rights Violations</h2>
      <ul class="space-y-2">
        <% @dashboard[:human_rights_violations].sort_by(&:sort_order).each_with_index do |item, index| %>
          <li class="flex justify-between items-center bg-white border border-gray-200 rounded-lg px-4 py-3 shadow-sm hover:bg-gray-50 transition">
            <%= link_to item.title, documenters_case_details_path(category_id: item.id, category_class: item.category_class), class: "text-gray-900 font-medium hover:underline" %>
            <span class="text-lg font-bold text-gray-800"><%= item.count %></span>
          </li>
        <% end %>
      </ul>
    </div>

    <!-- Charts Column -->
    <div class="lg:col-span-2 space-y-4">
      <h2 class="text-xl font-semibold text-gray-800">Individual Victims</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-semibold text-gray-900 mb-2">By Gender</h3>
          <%= pie_chart Victims::IndividualVictim.where.not(gender: nil).group(:gender).count %>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900 mb-2">By Age Bracket</h3>
          <%= bar_chart AgeBracket.chart_data %>
        </div>
      </div>
    </div>
  </div>

  <header class="pt-8">
    <h1 class="text-2xl font-bold text-gray-900 mt-2 mb-4">Cases By Country</h1>
  </header>
  <div class="border-t border-gray-200 mb-6"></div>
  <div id="geo_chart_div" style="width: 100%; height: 800px; max-width: 1300px;"></div>

</div>

<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
  google.charts.load('current', { packages: ['geochart'] });
  google.charts.setOnLoadCallback(drawRegionsMap);

  var countryMap = {
    <% Country.all.each_with_index do |country, idx| %>
      "<%= j country.name %>": "<%= country.id %>"<%= ',' unless idx == Country.count - 1 %>
    <% end %>
  };

  var countryShowUrlTemplate = "<%= country_path('__ID__') %>";

  function drawRegionsMap() {
    var data = google.visualization.arrayToDataTable([
      ['Country', 'Cases', { role: 'tooltip', p: {html: true} }],
      <% CaseDetails::CaseDetail
          .joins(:country)
          .group('countries.name', 'countries.id', 'countries.killings_count', 'countries.criminalizations_count', 'countries.human_rights_violations_count')
          .select('countries.name, countries.id, countries.killings_count, countries.criminalizations_count, countries.human_rights_violations_count, COUNT(case_details.id) as cases_count')
          .each do |record| %>
        [
          '<%= j record.name %>', 
          <%= record.cases_count %>, 
          `<div style="min-width: 150px; padding: 2px;">
             Cases: <%= record.cases_count %><br>
             Killings: <%= record.killings_count || 0 %><br>
             Criminalizations: <%= record.criminalizations_count || 0 %><br>
             Other Violations: <%= record.human_rights_violations_count || 0 %>
           </div>`
        ]<%= ',' unless record == CaseDetails::CaseDetail.last %>
      <% end %>
    ]);

    var options = {
      backgroundColor: '#ffffff',
      colorAxis: { colors: ['#ffd6d6', '#8A0303'] },
      tooltip: { isHtml: true }
    };

    var chart = new google.visualization.GeoChart(document.getElementById('geo_chart_div'));

    google.visualization.events.addListener(chart, 'select', function() {
      var selection = chart.getSelection();
      if (selection.length > 0) {
        var countryName = data.getValue(selection[0].row, 0);
        var countryUUID = countryMap[countryName];
        if (countryUUID) {
          var url = countryShowUrlTemplate.replace('__ID__', countryUUID);
          window.location.href = url;
        } else {
          alert("No country ID found for: " + countryName);
        }
      }
    });

    chart.draw(data, options);
  }
</script>
